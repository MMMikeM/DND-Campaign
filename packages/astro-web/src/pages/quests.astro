---
import Layout from '../layouts/Layout.astro';
import { db } from '../lib/db';
import { quests } from '@tome-keeper/shared';
import { desc } from 'drizzle-orm';

const allQuests = await db.select().from(quests).orderBy(desc(quests.id));
---

<Layout title="Quests">
	<div class="flex justify-between items-center mb-8">
		<h1 class="text-4xl font-bold">Quests</h1>
		<a href="/quests/new" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
			New Quest
		</a>
	</div>
	<div class="grid gap-6">
		{allQuests.map((quest) => (
			<div class="bg-white shadow rounded-lg p-6">
				<div class="flex justify-between items-start mb-4">
					<h2 class="text-2xl font-semibold">{quest.title}</h2>
					<div class="flex gap-2">
						<span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">
							{quest.type}
						</span>
						<span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm">
							{quest.difficulty}
						</span>
						{quest.adaptable && (
							<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
								Adaptable
							</span>
						)}
					</div>
				</div>
				<p class="text-gray-600 mb-4">{quest.description}</p>
				<div class="flex justify-end gap-4">
					<a href={`/quests/${quest.id}/edit`} class="text-blue-600 hover:text-blue-800">
						Edit
					</a>
					<button
						type="button"
						data-quest-id={quest.id}
						class="text-red-600 hover:text-red-800 delete-quest"
					>
						Delete
					</button>
				</div>
			</div>
		))}
	</div>
</Layout>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		document.querySelectorAll('.delete-quest').forEach((button) => {
			button.addEventListener('click', async () => {
				const questId = button.getAttribute('data-quest-id');
				if (!questId) return;

				if (!confirm('Are you sure you want to delete this quest?')) return;

				try {
					const response = await fetch(`/api/quests/${questId}`, {
						method: 'DELETE'
					});

					if (response.ok) {
						// Remove the quest card from the UI
						const questCard = button.closest('.bg-white');
						if (questCard) {
							questCard.remove();
						}
					} else {
						const data = await response.json();
						throw new Error(data.error || 'Failed to delete quest');
					}
				} catch (error) {
					console.error('Error:', error);
					alert('An error occurred while deleting the quest');
				}
			});
		});
	});
</script> 